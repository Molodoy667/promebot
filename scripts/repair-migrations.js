#!/usr/bin/env node

/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π–Ω–æ—ó —ñ—Å—Ç–æ—Ä—ñ—ó Supabase
 */

import { execSync } from 'child_process';

console.log('üîß Repairing migration history...\n');

const revertedMigrations = [
  '20251120011859', '20251120031631', '20251120042328', '20251120044026', '20251120051026',
  '20251120052227', '20251120064717', '20251120065219', '20251120070647', '20251120071222',
  '20251120073336', '20251120131857', '20251120132225', '20251120132929', '20251120135131',
  '20251121021951', '20251121024415', '20251121113356', '20251121120412', '20251121122907',
  '20251121155207', '20251121171841', '20251121172524', '20251121172957', '20251121173132',
  '20251121182856', '20251122064114', '20251122065436', '20251122070718', '20251122150735',
  '20251122152405', '20251122154606', '20251122155615', '20251123084005', '20251123153156',
  '20251123225459', '20251125102842', '20251125111432', '20251125113339', '20251125114022',
  '20251125122048', '20251125130137', '20251126094713', '20251126094814', '20251126095113',
  '20251128221828', '20251129004034', '20251129135024', '20251129190103', '20251129190557',
  '20251129191222', '20251129230810', '20251130013452', '20251130020119', '20251130045930',
  '20251130050850', '20251207060121', '20251207153721', '20251207154457'
];

const appliedMigrations = [
  '20251120011900', '20251120031632', '20251120042329', '20251120044027', '20251120051027',
  '20251120052228', '20251120064719', '20251120065220', '20251120070648', '20251120071223',
  '20251120073337', '20251120131858', '20251120132226', '20251120132930', '20251120135132',
  '20251121021952', '20251121024416', '20251121113357', '20251121120413', '20251121122908',
  '20251121155208', '20251121171842', '20251121172525', '20251121172958', '20251121173133',
  '20251121182857', '20251122064115', '20251122065437', '20251122070720', '20251122150736',
  '20251122152407', '20251122154608', '20251122155617', '20251123084006', '20251123153157',
  '20251123225500', '20251125102843', '20251125111433', '20251125113340', '20251125114023',
  '20251125122049', '20251125130138', '20251126094714', '20251126094815', '20251126095114',
  '20251128221829', '20251129004035', '20251129135025', '20251129190105', '20251129190558',
  '20251129191223', '20251129230811', '20251130013453', '20251130020121', '20251130045931',
  '20251130050851', '20251202150000', '20251203000000', '20251204000000', '20251204000001',
  '20251205000000', '20251206000000', '20251206100000', '20251206234500', '20251206234600',
  '20251207153722', '20251207154458', '20251210000000', '20251210000001', '20251210000002',
  '20251210000003', '20251210000004', '20251212000000', '20251213000001', '20251213000002'
];

try {
  // Mark reverted migrations
  console.log('‚è™ Marking reverted migrations...');
  for (const migration of revertedMigrations) {
    try {
      execSync(`supabase migration repair --status reverted ${migration}`, { 
        stdio: 'pipe',
        cwd: process.cwd()
      });
      process.stdout.write('.');
    } catch (err) {
      // Ignore errors for non-existent migrations
    }
  }
  console.log(' Done!\n');

  // Mark applied migrations
  console.log('‚úÖ Marking applied migrations...');
  for (const migration of appliedMigrations) {
    try {
      execSync(`supabase migration repair --status applied ${migration}`, { 
        stdio: 'pipe',
        cwd: process.cwd()
      });
      process.stdout.write('.');
    } catch (err) {
      // Ignore errors for non-existent migrations
    }
  }
  console.log(' Done!\n');

  console.log('‚úÖ Migration history repaired successfully!');
  console.log('\nüìù Now you can run: npm run db:migrate');
  
} catch (error) {
  console.error('\n‚ùå Failed to repair migrations:', error.message);
  process.exit(1);
}
