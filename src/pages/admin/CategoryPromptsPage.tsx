import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { getCategoryIcon } from "@/lib/category-icons";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { Separator } from "@/components/ui/separator";
import { useToast } from "@/components/ui/use-toast";
import { Loader2, Save, RefreshCw, Plus, Trash2, Edit2 } from "lucide-react";
import { PageBreadcrumbs } from "@/components/PageBreadcrumbs";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";

interface CategoryPrompt {
  id: string;
  category_name: string;
  custom_prompt: string;
  use_custom_prompt: boolean;
  emoji?: string;
  category_key?: string;
}

export default function CategoryPromptsPage() {
  const { toast } = useToast();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState<string | null>(null);
  const [prompts, setPrompts] = useState<CategoryPrompt[]>([]);
  const [editingPrompt, setEditingPrompt] = useState<CategoryPrompt | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);

  useEffect(() => {
    loadCategories();
  }, []);

  const loadCategories = async () => {
    try {
      setLoading(true);
      
      const { data, error } = await supabase
        .from('category_prompts')
        .select('*')
        .order('category_name');

      if (error) throw error;

      setPrompts(data || []);
    } catch (error: any) {
      console.error('Error loading prompts:', error);
      toast({
        title: "–ü–æ–º–∏–ª–∫–∞",
        description: error.message,
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (promptId: string, prompt: string, useCustom: boolean) => {
    try {
      setSaving(promptId);
      
      const { error } = await supabase
        .from('category_prompts')
        .update({
          custom_prompt: prompt,
          use_custom_prompt: useCustom,
        })
        .eq('id', promptId);

      if (error) throw error;

      toast({
        title: "–£—Å–ø—ñ—à–Ω–æ",
        description: "–ü—Ä–æ–º—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ",
      });
      
      await loadCategories();
    } catch (error: any) {
      console.error('Error saving:', error);
      toast({
        title: "–ü–æ–º–∏–ª–∫–∞",
        description: error.message,
        variant: "destructive",
      });
    } finally {
      setSaving(null);
    }
  };

  const handleEdit = (prompt: CategoryPrompt) => {
    setEditingPrompt(prompt);
    setIsDialogOpen(true);
  };

  const handleSaveDialog = async () => {
    if (!editingPrompt) return;
    
    // Validate
    if (!editingPrompt.category_name.trim()) {
      toast({
        title: "–ü–æ–º–∏–ª–∫–∞",
        description: "–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –æ–±–æ–≤'—è–∑–∫–æ–≤–∞",
        variant: "destructive",
      });
      return;
    }
    
    if (!editingPrompt.custom_prompt.trim()) {
      toast({
        title: "–ü–æ–º–∏–ª–∫–∞",
        description: "–ü—Ä–æ–º—Ç –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π",
        variant: "destructive",
      });
      return;
    }
    
    try {
      setSaving(editingPrompt.id || 'new');
      
      if (editingPrompt.id) {
        // Update existing
        const updateData: any = {
          category_name: editingPrompt.category_name,
          custom_prompt: editingPrompt.custom_prompt,
          use_custom_prompt: editingPrompt.use_custom_prompt,
        };
        
        // Add emoji if provided
        if (editingPrompt.emoji && editingPrompt.emoji.trim()) {
          updateData.emoji = editingPrompt.emoji.trim();
        }
        
        // Add category_key if provided
        if (editingPrompt.category_key && editingPrompt.category_key.trim()) {
          updateData.category_key = editingPrompt.category_key.trim();
        }
        
        const { error } = await supabase
          .from('category_prompts')
          .update(updateData)
          .eq('id', editingPrompt.id);

        if (error) throw error;
      } else {
        // Create new
        const insertData: any = {
          category_name: editingPrompt.category_name,
          custom_prompt: editingPrompt.custom_prompt,
          use_custom_prompt: editingPrompt.use_custom_prompt,
        };
        
        // Add emoji if provided
        if (editingPrompt.emoji && editingPrompt.emoji.trim()) {
          insertData.emoji = editingPrompt.emoji.trim();
        }
        
        // category_key will be auto-generated by trigger
        
        const { error } = await supabase
          .from('category_prompts')
          .insert(insertData);

        if (error) throw error;
      }

      toast({
        title: "–£—Å–ø—ñ—à–Ω–æ",
        description: editingPrompt.id ? "–ü—Ä–æ–º—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ" : "–ö–∞—Ç–µ–≥–æ—Ä—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ",
      });
      
      await loadCategories();
      setIsDialogOpen(false);
      setEditingPrompt(null);
    } catch (error: any) {
      console.error('Error saving:', error);
      toast({
        title: "–ü–æ–º–∏–ª–∫–∞",
        description: error.message,
        variant: "destructive",
      });
    } finally {
      setSaving(null);
    }
  };

  const updatePromptField = (field: keyof CategoryPrompt, value: any) => {
    if (editingPrompt) {
      setEditingPrompt({ ...editingPrompt, [field]: value });
    }
  };

  const resetToDefault = async (promptId: string, categoryName: string) => {
    const defaultPrompt = `–°—Ç–≤–æ—Ä–∏ —Ü—ñ–∫–∞–≤–∏–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É "${categoryName}". –ü–æ—Å—Ç –º–∞—î –±—É—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∏–º, –∑–∞–ª—É—á–∞—é—á–∏–º —Ç–∞ –∫–æ—Ä–∏—Å–Ω–∏–º –¥–ª—è —á–∏—Ç–∞—á—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ø—Ä–æ—Å—Ç–æ—é —ñ –∑—Ä–æ–∑—É–º—ñ–ª—É –º–æ–≤—É.`;
    
    await handleSave(promptId, defaultPrompt, false);
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  return (
    <div className="space-y-6 p-4 md:p-6">
      <PageBreadcrumbs />
      
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h2 className="text-2xl md:text-3xl font-bold">–ü—Ä–æ–º—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π</h2>
          <p className="text-sm md:text-base text-muted-foreground mt-2">
            –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–º—Ç—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó AI –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
          </p>
        </div>
        
        <div className="flex gap-2">
          <Button
            onClick={() => {
              setEditingPrompt({
                id: '',
                category_name: '',
                custom_prompt: '',
                use_custom_prompt: false,
                emoji: '',
                category_key: ''
              });
              setIsDialogOpen(true);
            }}
            className="shrink-0"
          >
            <Plus className="w-4 h-4 mr-2" />
            <span className="hidden sm:inline">–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</span>
            <span className="sm:hidden">–î–æ–¥–∞—Ç–∏</span>
          </Button>
          
          <Button
            onClick={loadCategories}
            variant="outline"
            size="icon"
            disabled={loading}
            className="shrink-0"
          >
            <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
          </Button>
        </div>
      </div>

      <div className="grid gap-4 md:gap-6">
        {prompts.map((prompt) => (
          <Card key={prompt.id} className="p-4 md:p-6 glass-effect border-border/50">
            <div className="space-y-4">
              <div className="flex items-start justify-between gap-4">
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    {getCategoryIcon(prompt.emoji, "w-8 h-8")}
                    <h3 className="text-lg font-bold">{prompt.category_name}</h3>
                  </div>
                  <p className="text-sm text-muted-foreground mt-1">
                    {prompt.use_custom_prompt 
                      ? "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–∞—Å—Ç–æ–º–Ω–∏–π –ø—Ä–æ–º—Ç" 
                      : "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π –ø—Ä–æ–º—Ç"}
                  </p>
                  {prompt.category_key ? (
                    <p className="text-xs text-muted-foreground mt-1">
                      –ö–ª—é—á: <code className="bg-muted px-1 py-0.5 rounded">{prompt.category_key}</code>
                    </p>
                  ) : (
                    <p className="text-xs text-destructive mt-1">
                      ‚ö†Ô∏è –í—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–ª—é—á –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
                    </p>
                  )}
                </div>
                
                <div className="flex items-center gap-2">
                  <div className="flex items-center gap-2">
                    <Label htmlFor={`switch-${prompt.id}`} className="text-sm">
                      –ö–∞—Å—Ç–æ–º–Ω–∏–π
                    </Label>
                    <Switch
                      id={`switch-${prompt.id}`}
                      checked={prompt.use_custom_prompt}
                      onCheckedChange={(checked) =>
                        handleSave(prompt.id, prompt.custom_prompt, checked)
                      }
                      disabled={saving === prompt.id}
                    />
                  </div>
                </div>
              </div>

              <Separator />

              <div className="space-y-2">
                <Label className="text-sm font-medium">–ü—Ä–æ–º—Ç</Label>
                <div className="relative">
                  <Textarea
                    value={prompt.custom_prompt}
                    readOnly
                    className="min-h-[100px] resize-none bg-muted/50 cursor-pointer"
                    onClick={() => handleEdit(prompt)}
                  />
                  <Button
                    size="sm"
                    variant="ghost"
                    className="absolute top-2 right-2"
                    onClick={() => handleEdit(prompt)}
                  >
                    <Edit2 className="w-4 h-4" />
                  </Button>
                </div>
              </div>

              <div className="flex gap-2">
                <Button
                  onClick={() => handleEdit(prompt)}
                  variant="outline"
                  className="flex-1"
                  disabled={saving === prompt.id}
                >
                  <Edit2 className="w-4 h-4 mr-2" />
                  –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                </Button>
                
                <Button
                  onClick={() => resetToDefault(prompt.id, prompt.category_name)}
                  variant="outline"
                  disabled={saving === prompt.id}
                  title="–°–∫–∏–Ω—É—Ç–∏ –¥–æ –¥–µ—Ñ–æ–ª—Ç—É"
                >
                  {saving === prompt.id ? (
                    <Loader2 className="w-4 h-4 animate-spin" />
                  ) : (
                    <RefreshCw className="w-4 h-4" />
                  )}
                </Button>
                
                <Button
                  onClick={async () => {
                    if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é "${prompt.category_name}"?`)) {
                      try {
                        setSaving(prompt.id);
                        const { error } = await supabase
                          .from('category_prompts')
                          .delete()
                          .eq('id', prompt.id);
                        
                        if (error) throw error;
                        
                        toast({
                          title: "–£—Å–ø—ñ—à–Ω–æ",
                          description: "–ö–∞—Ç–µ–≥–æ—Ä—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ",
                        });
                        
                        await loadCategories();
                      } catch (error: any) {
                        toast({
                          title: "–ü–æ–º–∏–ª–∫–∞",
                          description: error.message,
                          variant: "destructive",
                        });
                      } finally {
                        setSaving(null);
                      }
                    }
                  }}
                  variant="outline"
                  disabled={saving === prompt.id}
                  className="text-destructive hover:bg-destructive/10"
                  title="–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é"
                >
                  <Trash2 className="w-4 h-4" />
                </Button>
              </div>
            </div>
          </Card>
        ))}
      </div>

      {/* Edit Dialog */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent className="sm:max-w-[700px]">
          <DialogHeader>
            <DialogTitle>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ–º—Ç: {editingPrompt?.category_name}</DialogTitle>
            <DialogDescription>
              –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤ —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
            </DialogDescription>
          </DialogHeader>
          
          {editingPrompt && (
            <div className="space-y-4 py-4">
              <div className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="category-name">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</Label>
                  <Input
                    id="category-name"
                    value={editingPrompt.category_name}
                    onChange={(e) => updatePromptField('category_name', e.target.value)}
                    placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó, –°–ø–æ—Ä—Ç, –ú—É–∑–∏–∫–∞..."
                    disabled={!!editingPrompt.id}
                  />
                  {!editingPrompt.id && (
                    <p className="text-xs text-muted-foreground">
                      –ö–ª—é—á –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑ –Ω–∞–∑–≤–∏
                    </p>
                  )}
                </div>
                
                <div className="space-y-2">
                  <Label htmlFor="emoji">–ï–º–æ–¥–∑—ñ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</Label>
                  <Input
                    id="emoji"
                    value={editingPrompt.emoji || ''}
                    onChange={(e) => updatePromptField('emoji', e.target.value)}
                    placeholder="üìù (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)"
                    maxLength={2}
                  />
                  <p className="text-xs text-muted-foreground">
                    –ó–∞–ª–∏—à –ø—É—Å—Ç–∏–º –¥–ª—è üìù –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                  </p>
                </div>
                
                {editingPrompt.id && (
                  <div className="space-y-2">
                    <Label htmlFor="category-key">–ö–ª—é—á –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</Label>
                    <Input
                      id="category-key"
                      value={editingPrompt.category_key || ''}
                      onChange={(e) => updatePromptField('category_key', e.target.value)}
                      placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: technology, sport, music..."
                    />
                    <p className="text-xs text-muted-foreground">
                      –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏, —Ü–∏—Ñ—Ä–∏, –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è)
                    </p>
                  </div>
                )}
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="prompt">–ü—Ä–æ–º—Ç</Label>
                <Textarea
                  id="prompt"
                  value={editingPrompt.custom_prompt}
                  onChange={(e) => updatePromptField('custom_prompt', e.target.value)}
                  className="min-h-[200px] resize-y"
                  placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–º—Ç –¥–ª—è AI –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó..."
                />
                <p className="text-xs text-muted-foreground">
                  –ü—ñ–¥–∫–∞–∑–∫–∞: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —á—ñ—Ç–∫—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, —â–æ–± AI –∫—Ä–∞—â–µ —Ä–æ–∑—É–º—ñ–≤ —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏
                </p>
              </div>

              <div className="flex items-center space-x-2">
                <Switch
                  id="use-custom"
                  checked={editingPrompt.use_custom_prompt}
                  onCheckedChange={(checked) => updatePromptField('use_custom_prompt', checked)}
                />
                <Label htmlFor="use-custom" className="text-sm">
                  –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ–π –ø—Ä–æ–º—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
                </Label>
              </div>
            </div>
          )}
          
          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => {
                setIsDialogOpen(false);
                setEditingPrompt(null);
              }}
            >
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </Button>
            <Button onClick={handleSaveDialog} disabled={saving !== null}>
              {saving ? (
                <>
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...
                </>
              ) : (
                <>
                  <Save className="w-4 h-4 mr-2" />
                  –ó–±–µ—Ä–µ–≥—Ç–∏
                </>
              )}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
